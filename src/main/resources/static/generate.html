<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Administraci√≥n QR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root{--c1:#00D9E1;--c2:#00B4BC;--ok:#10B981;--err:#EF4444}
    body{font-family:Segoe UI,Tahoma,Arial,sans-serif;background:#f6fffe;margin:0;padding:20px}
    .container{max-width:1100px;margin:0 auto}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,217,225,.25);padding:24px;margin-bottom:20px;border:2px solid #b7f6f9}
    h1{margin:0 0 8px 0;color:#008b94}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .label{font-weight:600;color:#0b6f74;margin-bottom:6px}
    .input,.file{width:100%;padding:10px;border:1px solid #b7f6f9;border-radius:8px;background:#f0feff}
    .btn{background:linear-gradient(135deg,var(--c1),var(--c2));color:#fff;border:none;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn:hover{filter:brightness(1.05)}
    .ok{background:#ecfdf5;border-left:6px solid var(--ok);padding:14px;border-radius:10px;margin:10px 0;color:#065f46}
    .err{background:#fee2e2;border-left:6px solid var(--err);padding:14px;border-radius:10px;margin:10px 0;color:#7f1d1d}
    .mono{font-family:"Courier New",monospace;white-space:pre-wrap;word-break:break-word}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    /* QR preview */
    .qr-wrap{display:none;margin-top:14px}
    .qr-grid{display:grid;grid-template-columns:320px 1fr; gap:18px}
    @media(max-width:900px){.qr-grid{grid-template-columns:1fr}}
    .qr-box{background:#fff;border:2px dashed #b7f6f9;border-radius:14px;padding:16px;text-align:center}
    .qr-title{font-weight:800;color:#008b94;margin-bottom:8px}
    .select{padding:10px;border:1px solid #b7f6f9;border-radius:8px;background:#f8ffff}
    .hint{color:#0b6f74;font-size:.9rem;margin-top:6px}
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Panel administrador</h1>
    <div>Genera QR con datos personales (√∫nico e idempotente)</div>
  </div>

  <div id="alertBox" class="card" style="display:none;"></div>

  <div class="card">
    <h2>Generar QR con datos personales</h2>
    <div class="row">
      <div>
        <div class="label">Nombre</div>
        <input id="nombre" class="input" placeholder="Nombre(s)"/>
      </div>
      <div>
        <div class="label">Apellidos</div>
        <input id="apellidos" class="input" placeholder="Apellidos"/>
      </div>
      <div>
        <div class="label">CI (obligatorio)</div>
        <input id="ci" class="input" placeholder="Nro. CI"/>
      </div>
      <div>
        <div class="label">Fecha de nacimiento</div>
        <input id="fechaNacimiento" class="input" type="date"/>
      </div>
      <!-- Reemplaza TODO el div anterior por esta sola l√≠nea -->
<input type="hidden" id="cargo" name="cargo" value="Voluntario">

      <div>
        <div class="label">Foto (jpg/png)</div>
        <input id="foto" class="file" type="file" accept="image/*"/>
      </div>
      <div>
  <div class="label">Departamento</div>
  <select id="departamento" class="input">
    <option value="">-- Seleccionar --</option>
    <option value="La Paz">La Paz</option>
    <option value="Santa Cruz">Santa Cruz</option>
    <option value="Cochabamba">Cochabamba</option>
  </select>
</div>

<div>
  <div class="label">√Årea de voluntariado</div>
  <select id="areaVoluntariado" class="input">
    <option value="">-- Seleccionar --</option>
    <option value="Recolecci√≥n">Recolecci√≥n</option>
    <option value="Seguridad">Seguridad</option>
    <option value="√Årea de apoyo">√Årea de apoyo</option>
    <option value="Cocina">Cocina</option>
    <option value="Ayudante de cocina">Ayudante de cocina</option>
    <option value="Mesero">Mesero</option>
    <option value="Redes sociales">Redes sociales</option>
    <option value="Reportero">Reportero</option>
  </select>
</div>

    </div>
    <div class="actions" style="margin-top:12px">
      <button id="btnData" class="btn" onclick="generateWithData()">üíæ Generar con datos</button>
      <button class="btn" id="btnPerfil" disabled onclick="irPerfil()">üëÅÔ∏è Ver perfil</button>
    </div>
    <div id="resData" class="mono" style="margin-top:12px;"></div>

    <!-- PREVIEW DEL QR + DESCARGA -->
    <div id="qrWrap" class="qr-wrap">
      <div class="qr-grid">
        <div class="qr-box">
          <div class="qr-title">üì± C√≥digo QR generado</div>
          <div id="qrcode" style="display:inline-block"></div>
          <div class="actions" style="justify-content:center;margin-top:10px">
            <button class="btn" onclick="downloadQR()">üì• Descargar PNG</button>
          </div>
          <div class="hint">Sugerido: usar la <strong>URL p√∫blica</strong> para verificaci√≥n directa.</div>
        </div>
        <div>
          <div class="label">Contenido del QR</div>
          <select id="qrPayloadType" class="select" onchange="refreshQR()">
            <option value="url">üåê URL p√∫blico (recomendado)</option>
            <option value="hash">üîë plain_text_hash</option>
            <option value="encrypted">üîí encrypted_text</option>
            <option value="json">üì¶ JSON {h,c,iv}</option>
          </select>

          <div class="label" style="margin-top:12px">Payload actual</div>
          <div id="payloadPreview" class="mono" style="background:#f0feff;border:1px solid #b7f6f9;border-radius:8px;padding:10px;max-height:160px;overflow:auto"></div>

          <div class="label" style="margin-top:12px">IDs devueltos</div>
          <div class="mono" style="background:#f8ffff;border:1px solid #b7f6f9;border-radius:8px;padding:10px">
            <div><strong>id:</strong> <span id="meta_id">‚Äî</span></div>
            <div><strong>hash:</strong> <span id="meta_hash">‚Äî</span></div>
            <div><strong>iv:</strong> <span id="meta_iv">‚Äî</span></div>
          </div>
        </div>
      </div>
    </div>
    <!-- FIN PREVIEW -->
  </div>

  <div class="card actions">
    <button class="btn" onclick="window.location.href='/logout'">üö™ Cerrar sesi√≥n</button>
    <button class="btn" onclick="window.location.href='/verify.html'">üîç Ir a verificador</button>
  </div>
</div>

<script>
  const API = '/api/qr';
  const alertBox = document.getElementById('alertBox');

  // √öltima respuesta para renderizar QR y perfil
  let lastData = null;
  let qrInstance = null;

  function showAlert(html, ok=true){
    alertBox.style.display='block';
    alertBox.innerHTML = ok ? `<div class="ok">${html}</div>` : `<div class="err">${html}</div>`;
    clearTimeout(showAlert._t);
    showAlert._t = setTimeout(()=>{ alertBox.style.display='none'; }, 6000);
  }

  function lock(btn, txt){
    if(!btn) return ()=>{};
    const old = btn.textContent; btn.disabled = true; btn.textContent = txt;
    return ()=>{ btn.disabled = false; btn.textContent = old; };
  }

  async function generateWithData(){
  const unlock = lock(document.getElementById('btnData'),'‚è≥ Enviando...');
  const nombre = document.getElementById('nombre').value.trim();
  const apellidos = document.getElementById('apellidos').value.trim();
  const ci = document.getElementById('ci').value.trim();
  const fechaNacimiento = document.getElementById('fechaNacimiento').value;
  const cargo = document.getElementById('cargo').value.trim();
  const foto = document.getElementById('foto').files[0];

  // ‚úÖ nuevos:
  const departamento = document.getElementById('departamento').value;
  const areaVoluntariado = document.getElementById('areaVoluntariado').value;

  if (!ci){ showAlert('El CI es obligatorio.', false); unlock(); return; }

  const fd = new FormData();
  fd.append('nombre', nombre);
  fd.append('apellidos', apellidos);
  fd.append('ci', ci);
  if (fechaNacimiento) fd.append('fechaNacimiento', fechaNacimiento);
  if (cargo) fd.append('cargo', cargo);
  if (foto) fd.append('foto', foto);

  // ‚úÖ enviar nuevos campos
  if (departamento) fd.append('departamento', departamento);
  if (areaVoluntariado) fd.append('areaVoluntariado', areaVoluntariado);

  try{
    const r = await fetch(`${API}/generate-with-data`,{method:'POST', body:fd});
    const j = await r.json();
    document.getElementById('resData').textContent = JSON.stringify(j,null,2);

    if (j.success){
      lastData = j; // guardamos todo
      document.getElementById('btnPerfil').disabled = false;
      showAlert(j.created ? 'QR creado' : 'Registro existente devuelto (idempotente).', true);
      // Mostrar QR
      renderQRSection();
    } else {
      showAlert('Error: '+(j.message||'fall√≥ la generaci√≥n'), false);
    }
  }catch(e){
    showAlert('Fallo de conexi√≥n: '+e.message, false);
  } finally { unlock(); }
}

  function currentQRPayload(){
    if (!lastData) return '';
    const type = document.getElementById('qrPayloadType').value;

    // tolerante a nombres
    const hash = lastData.plain_text_hash || lastData.plainTextHash || lastData.hash;
    const enc  = lastData.encrypted_text   || lastData.encryptedText;
    const iv   = lastData.iv               || lastData.iv_value || lastData.ivValue;

    // 1) usar URL del backend si existe; 2) fallback construyendo con encrypted_text
    const url  = lastData.qr_url || lastData.qrUrl
              || (enc ? `${window.location.origin}/qr/profile?encryptedText=${encodeURIComponent(enc)}` : '');

    if (type === 'url')       return url || '';
    if (type === 'hash')      return hash || enc || '';
    if (type === 'encrypted') return enc || hash || '';
    // JSON compuesto
    return JSON.stringify({ h: hash || '', c: enc || '', iv: iv || '' });
  }

  function renderQRSection(){
    const wrap = document.getElementById('qrWrap');
    const qrel = document.getElementById('qrcode');
    const payloadBox = document.getElementById('payloadPreview');

    // metadatos visibles
    document.getElementById('meta_id').textContent = lastData.id ?? '‚Äî';
    document.getElementById('meta_hash').textContent = (lastData.plain_text_hash || lastData.plainTextHash || '‚Äî');
    document.getElementById('meta_iv').textContent = (lastData.iv || lastData.iv_value || '‚Äî');

    // payload
    const text = currentQRPayload();
    payloadBox.textContent = text || '‚Äî';

    // (re)generar QR
    qrel.innerHTML = '';
    qrInstance = new QRCode(qrel, {
      text: text || '',
      width: 280,
      height: 280,
      colorDark: "#000000",
      colorLight: "#FFFFFF",

      correctLevel: QRCode.CorrectLevel.H
    });

    wrap.style.display = 'block';
  }

  function refreshQR(){
    if (!lastData) return;
    renderQRSection();
  }

  function downloadQR(){
    const canvas = document.querySelector('#qrcode canvas');
    if (!canvas){ showAlert('No hay canvas de QR para descargar.', false); return; }
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    const suffix = (document.getElementById('qrPayloadType').value || 'url');
    const name = (lastData.plain_text_hash || lastData.plainTextHash || 'qr') + '_' + suffix + '.png';
    a.href = url; a.download = name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showAlert('üì• PNG descargado.', true);
  }

  function irPerfil(){
    if (!lastData){
      showAlert('No hay datos para abrir perfil.', false); return;
    }
    // Mantengo tu l√≥gica: /perfil por hash|encrypted (no afecta al QR)
    const enc = lastData.encrypted_text || lastData.encryptedText;
    const hash = lastData.plain_text_hash || lastData.plainTextHash;
    const url = hash
      ? `/perfil?h=${encodeURIComponent(hash)}`
      : `/perfil?e=${encodeURIComponent(enc||'')}`;
    window.location.href = url;
  }
</script>
</body>
</html>
